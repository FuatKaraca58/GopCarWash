<!DOCTYPE html>

<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GopCarWash</title>

  <!-- Firebase SDK dosyaları -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<style>
    body { font-family: Arial; padding: 20px; }


#listeFormu {
  max-height: calc(100vh - 60px); /* üstteki menülere yer bırakır */
  overflow-y: auto;
  margin-top: 2px; /* liste yukarı çıkmasın */
  padding: 10px;
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  min-height: 100vh;
  overflow-x: hidden;
  box-sizing: border-box;
}


#kayitFormu {
  display: none;
  position: absolute; /* veya relative */
  top: 0;
  left: 0;
  width: 100%;
  min-height: 100dvh;
  background: #fefefe;
  padding: 10px;
  box-sizing: border-box;
  overflow-y: auto;
  z-index: 9999;
}

#kayitFormu input,
  #kayitFormu select,
  #kayitFormu textarea {
    width: 100%;
    font-size: 16px;
    margin-bottom: 12px;
    box-sizing: border-box;
  }
    .toggle-button { padding: 5px 10px; margin: 5px; border: 1px solid #999; cursor: pointer; display: inline-block; }
    .toggle-button.active { background-color: green; color: white; }
    #toplamOdeme { background: lightgreen; padding: 10px; margin-top: 4px; font-weight: bold; display: inline-block; }
 
  
#ayarlarFormu button {
  width: auto;
  min-width: 140px;
  padding: 6px 12px;
  font-size: 14px;
}

#personelKutulari {
  display: block;
  margin-left: 30px;
  max-width: 300px;
}

#personelKutulari > div {
  display: flex;
  align-items: center;
  padding: 2px 0;
  gap: 8px;
}

#personelKutulari input[type="text"] {
  width: 180px;
  padding: 4px 6px;
  font-size: 15px;
  border: 1px solid #ccc;
}

#personelKutulari input[type="checkbox"] {
  transform: scale(1.2);
}

#personelKutulari label {
  font-size: 13px;
  white-space: nowrap;
}

#cariKutulari {
  display: block;
  margin-left: 30px;
  max-width: 300px;
}

#cariKutulari input[type="text"] {
  width: 180px;
  padding: 4px 6px;
  font-size: 15px;
  border: 1px solid #ccc;
  margin-bottom: 2px;
}

/* Ana menü butonlarını yatayda ortala */
    display: flex;
    flex-wrap: wrap;
    justify-content: center !important;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

/* Mobilde dikey dizilim */
        flex-direction: column;
        align-items: center !important;
    }
    button {
        width: 90%;
        max-width: 300px;
        margin: 0.2rem auto;
    }
}

  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  width: 100%;
}
    flex-direction: column;
    align-items: center;
  }
}
</style>
<style>
  body {
    font-family: Arial;
    padding: 10px;
    max-width: 100%;
    box-sizing: border-box;
  }

  input, select, button {
    width: 100%;
    max-width: 300px;
    margin: 6px 0;
    font-size: 16px;
  }

 table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 8px;
  font-size: 15px;
  border: 1px solid #ccc;
  text-align: left;
}

  .toggle-button {
    padding: 8px 12px;
    margin: 4px;
    font-size: 16px;
    display: inline-block;
  }

  #loginEkrani input {
    width: 90%;
    max-width: 300px;
  }

  #loginEkrani button {
    font-size: 16px;
    padding: 8px 16px;
  }
</style>
<style>
.toggle-button input[type="checkbox"]:checked + label {
  background-color: #b3ffcc !important; /* Açık yeşil */
}
</style><style>
#menuContainer {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  align-items: center;
  width: 100%;
  padding-left: 30px;
}
@media (max-width: 600px) {
  #menuContainer {
    flex-direction: column;
    align-items: flex-start;
    padding-left: 30px;
  }
}
</style></head>
<body>
<div id="menuContainer" style="
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  align-items: center;
  padding-left: 30px;
  gap: 6px;
  margin-top: 20px;
  margin-bottom: 20px;
">
<button class="menu-button" id="btnListe" title="Ana Menü">🏠</button><button class="menu-button" id="btnYeniArac" title="Yeni Araç">🚗</button><button class="menu-button" id="btnRapor" title="Rapor">📊</button><button class="menu-button" id="btnAyarlar" title="Ayarlar">⚙️</button></div>
<style>
.odenmis-kayit { background-color: #ccffcc; }  /* yeşil */  /* açık mavi */
.odenmemis-kayit { background-color: #ffcccc; }  /* açık pembe */  /* açık pembe */
.eksik-odeme-kayit { background-color: #ffe680; }  /* turuncu */
.iptal-kayit {
  text-decoration: line-through;
  background-color: #e6f0ff !important; /* açık mavi */
  color: red !important;
}</style>
<style>
.menu-button {
  width: 40px;
  height: 40px;
  font-size: 20px;
  border-radius: 8px;
  border: 1px solid #aaa;
  margin: 4px;
  cursor: pointer;
  background-color: white;
}

.menu-button:hover {
  background-color: #def;
}
</style>
<div id="loginEkrani" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#eef; display:flex; align-items:center; justify-content:center; z-index:9999;">
<div style="background:white; padding:30px; border:1px solid #ccc; box-shadow:2px 2px 10px rgba(0,0,0,0.2); text-align:center;">
<h2>Giriş Yap</h2>
<input id="kullaniciAdi" placeholder="Kullanıcı Adı" style="margin:5px; padding:8px; width:200px;" type="text"/><br/>
<input id="sifre" placeholder="Şifre" style="margin:5px; padding:8px; width:200px;" type="password"/><br/>
<button onclick="kontrolEtGiris()">Giriş</button>
<p id="girisHata" style="color:red; display:none;">Hatalı kullanıcı adı veya şifre</p>
</div>
</div>
<div id="kayitFormu" style="
  max-width: 650px;
  top: 120px;
  left: 10px;
  position: absolute;
  background: #ffe6e6;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  padding: 10px;
  box-sizing: border-box;
  max-height: calc(100vh - 80px);
  overflow-y: auto;
">
<div style="display: flex; align-items: center; gap: 100px;"><h2>Araç Kayıt Formu</h2><div id="toplamOdeme" style=" padding-left: 40px; float: right; margin-right: 40px">Toplam Ödeme: 0 ₺</div></div><div style="display: flex; gap: 10px; flex-wrap: wrap;"><label>🚗 <input id="plaka" placeholder="Plaka No" style="width: 120px;" type="text"/></label><label>💬 <input id="aciklama" placeholder="Açıklama" style="width: 200px;" type="text"/></label></div><div style="display: block; margin-top: 4px;">
<label>🚿 
  <select id="anaIslem" onchange="guncelleToplamOdeme()" style="width: 100px;">
<!-- Dinamik olarak doldurulacak -->
</select>
</label>
<label>👨‍🔧 <select id="personel" style="width: 100px;"><option>Seçiniz</option></select></label>
<div style="display: block; margin-top: 4px;">
</div>
<div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 4px;"><label>💰 <select id="odemeTipi" style="width: 100px;">
<option>Seçiniz</option><option>nakit</option><option>kredi kartı</option><option>vadeli</option>
</select>
</label><label>Nakit ₺: <input id="nakitOdeme" style="width: 80px;" type="number" value="0"/></label><label>K.Kart ₺: <input id="krediKartOdeme" style="width: 80px;" type="number" value="0"/></label><label>Vadeli ₺: <input id="vadeliOdeme" style="width: 80px;" type="number" value="0"/></label></div><label>🏢 <select id="cari" style="width: 100px;"><option>Bireysel</option></select></label>
<div style="display: block; margin-top: 4px;">
</div>
</div><div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 2px; align-items: center;"><span style="margin-right: 10px; font-weight: bold;">Ekstralar:</span>
<div class="toggle-button" data-value="E1" onmouseup="toggleEkstra(this)" style="display: inline-block; width: 42px; margin: 2px; text-align: center;">OZON</div>
<div class="toggle-button" data-value="E2" onmouseup="toggleEkstra(this)" style="display: inline-block; width: 42px; margin: 2px; text-align: center;">CİLA</div>
<div class="toggle-button" data-value="E3" onmouseup="toggleEkstra(this)" style="display: inline-block; width: 42px; margin: 2px; text-align: center;">BUHAR</div>
<div class="toggle-button" data-value="E4" onmouseup="toggleEkstra(this)" style="display: inline-block; width: 52px; margin: 2px; text-align: center;">DETAY1</div>
<div class="toggle-button" data-value="E5" onmouseup="toggleEkstra(this)" style="display: inline-block; width: 52px; margin: 2px; text-align: center;">DETAY2</div>
<div class="toggle-button" data-value="E6" onmouseup="toggleEkstra(this)" style="display: inline-block; width: 72px; margin: 2px; text-align: center;">PASTACİLA</div></div>
<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 2px;"></div><div style="margin-top: 6px;">
<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px;"><label>Ücret Farkı: <input id="ucretFarki" onchange="guncelleToplamOdeme()" style="width: 80px;" type="number" value="0"/></label><label>Harici Ücret: <input id="hariciUcret" onchange="guncelleToplamOdeme()" style="width: 80px;" type="number" value="0"/></label></div>
</div>
<div style="display: flex; gap: 6px; margin-top: 4px; justify-content: flex-start;"></div><div style="display: flex; gap: 6px; margin-top: 4px; justify-content: flex-start;"><button class="menu-button" id="btnKaydet" style="min-width: 70px; font-size: 12px; padding: 4px;">💾</button><button class="menu-button" id="btnSil" style="min-width: 70px; font-size: 12px; padding: 4px;">🗑️</button><button class="menu-button" id="btnVazgec" style="min-width: 70px; font-size: 12px; padding: 4px;">❌</button></div></div><div style="display: flex; gap: 6px; margin-top: 6px; justify-content: flex-start;"></div>
<div id="listeFormu" style="margin-top: 20px;">
<div id="listeAlani">
<div style="background: #e6f0ff; margin-bottom: 10px; padding: 10px;">
<!-- 1. SATIR -->
<div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px;">
<label style="display: flex; align-items: center; gap: 4px;">⏰ 
        <input id="filterStartDate" type="date" value=""/>
</label>
<label style="display: flex; align-items: center; gap: 4px;">🚗 
        <input id="filterPlaka" placeholder="Plaka No" style="width: 80px;" type="text"/>
</label>
<label style="display: flex; align-items: center; gap: 4px;">👨‍🔧 
        <input id="filterPersonel" placeholder="Personel Adı" style="width: 80px;" type="text"/>
</label>
<label style="display: flex; align-items: center; gap: 4px;">🏢 
        <input id="filterCariTipi" placeholder="Cari Adı" style="width: 80px;" type="text"/>
</label>
</div>
<!-- 2. SATIR -->
<div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: space-between;">
<div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
<label style="display: flex; align-items: center; gap: 4px;">🏁 
          <input id="filterEndDate" type="date" value=""/>
</label>
<span class="toggle-button active" id="filterOdenmis" onclick="this.classList.toggle('active')" style="padding: 5px 10px;" title="Ödenmişler">Ödenmişler</span>
<span class="toggle-button active" id="filterOdenmemis" onclick="this.classList.toggle('active')" style="padding: 5px 10px;" title="Ödenmemişler">Ödenmemişler</span>
<button class="menu-button" id="filterBtn" onclick="filtreleKayitlar()" title="Filtrele">🔍</button>
<button class="menu-button" id="clearBtn" onclick="temizleFiltreVeListele()" title="Temizle">✖</button>
</div>
<!-- ✅ Özet Alanı -->
<div id="listeOzeti" style="font-weight: bold; text-align: right; color: #003366;"></div>
</div>
</div>
<!-- Liste tablosu alanı -->
<div style="overflow-x: auto;">
<table border="1" cellpadding="5" cellspacing="0" style="width: 100%;">
<thead>
<tr>
<th style="background-color: lightgreen; text-align: left;">Sıra No</th>
<th style="background-color: lightgreen; text-align: left;">Plaka</th>
<th style="background-color: lightgreen; text-align: left;">İşlem</th>
<th style="background-color: lightgreen; text-align: left;">Ekstra</th>
<th style="background-color: lightgreen; text-align: left;">Ücret</th>
<th style="background-color: lightgreen; text-align: left;">Cari</th>
<th style="background-color: lightgreen; text-align: left;">Personel</th>
<th style="background-color: lightgreen; text-align: left;">Ödeme</th>
<th style="background-color: lightgreen; text-align: left;">Kayıt Zamanı</th>
</tr>
</thead>
<tbody id="listeGovde"></tbody>
</table>
</div>
</div>
</div>
<div id="personelFormu" style="display:none; border: 1px solid #ccc; padding: 20px; margin-top: 6px; background: #eef; width: 680px; margin-left: 30px;">
<h2>Personel Listesi</h2>
<div id="personelKutulari">
<!-- JavaScript ile doldurulacak -->
</div>
<br/>
<button onclick="aktarPersonelComboboxa()">Kayıt Formuna Aktar</button>
</div>
<div id="cariFormu" style="display:none; border: 1px solid #ccc; padding: 20px; margin-top: 6px; background: #ffe; width: 680px; margin-left: 30px;">
<h2>Cari Listesi</h2>
<div id="cariKutulari">
<!-- JavaScript ile doldurulacak -->
</div>
<br/>
<button onclick="aktarCariComboboxa()">Kayıt Formuna Aktar</button>
</div>
<div id="raporFormu" style="
  display: none;
  position: fixed;
  margin-top: 20px;
  top: 100px;
  left: 10px;
  width: 680px;
  height: auto;
  max-height: calc(100vh - 120px); /* DÜZENLENDİ */
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 20px;
  background: #ddf;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  box-sizing: border-box;
  z-index: 1000;
">
<h2>Personel Hakediş Raporu</h2>
<label>Rapor Tarihi:
    <input id="raporTarihi" type="date"/>
</label>
<div id="raporTabloAlani" style="margin-top: 6px;"></div>
</div>
<!-- Ayarlar Formu (fiyat listesi dahil) -->
<div id="ayarlarFormu" style="display: none; border: 1px solid #ccc; margin-top: 20px; padding: 10px;">

  <!-- 1. Kısım: Personel ve Cari Listeleri (Açık Mavi) -->
  <fieldset style="margin-bottom: 16px; background: #e6f0ff; padding: 12px; border: 1px solid #99c;">
    <legend><strong>1. Personel ve Cari Listeleri</strong></legend>
    <button id="btnPersonel">Personel Listesi</button>
    <button id="btnCari">Cari Listesi</button>
  </fieldset>

  <!-- 2. Kısım: Gelişmiş Ayarlar (Turuncu) -->
  <fieldset style="margin-bottom: 16px; background: #ffe0b3; padding: 12px; border: 1px solid #cc9900;">
    <legend><strong>2. Gelişmiş Ayarlar</strong></legend>

    <div style="margin-bottom: 6px;">
      <button id="btnSifirlaDB">Tüm Verileri Sil</button>
    </div>

    <div style="margin-bottom: 6px;">
      <button type="button" id="btnBulutaKaydet">Buluta Kaydet</button>
    </div>

    <div id="yedekSecimAlani" style="margin-bottom: 6px;">
      <label for="yedekSecim">Yedek Seç:</label>
      <select id="yedekSecim">
        <option value="">-- Yedek Seçin --</option>
      </select>
    </div>

    <div>
      <button type="button" id="btnBuluttanYukle">Buluttan Yükle</button>
    </div>
  </fieldset>

  <!-- 3. Kısım: Fiyat Listesi (Zaten Sarı) -->
  <fieldset style="background: #ffd; padding: 12px;">
    <legend><strong>3. Fiyat Listesi</strong></legend>
    <div id="fiyatlarListesi"></div>
    <br/>
    <button onclick="kaydetFiyatlar()">💾 Kaydet</button>
  </fieldset>

</div>



<script>
let db;  
let CihazIsmi = "";
let fiyatlarCache = [];
const adminSifre = "1536"; 

function kontrolEtGiris() {
  const kullanici = document.getElementById("kullaniciAdi").value.trim().toLowerCase();
  const sifre = document.getElementById("sifre").value.trim();

  const kullanicilar = {
    "ayse": "123",
    "mucize": "321",
    "lisan": "5858"
  };

  if (kullanicilar[kullanici] && kullanicilar[kullanici] === sifre) {
    CihazIsmi = kullanici; // Cihaz ismi giriş yapan kullanıcı olur
    console.log("Aktif kullanıcı cihaz ismi:", CihazIsmi); // ✅ Başarılı girişte log bas
    document.getElementById("loginEkrani").style.display = "none";
    gosterSadeceListe();
  } else {
    const hata = document.getElementById("girisHata");
    hata.style.display = "block";
    hata.textContent = "Hatalı kullanıcı adı veya şifre!";
  }
}


function fiyatlariYukleVeCachele(callback) {
  const tx = db.transaction("Fiyatlar", "readonly");
  const store = tx.objectStore("Fiyatlar");
  store.getAll().onsuccess = function (e) {
    fiyatlarCache = e.target.result;
    if (callback) callback(); // İlk yüklemeden sonra işlem yapacaksak
  };
}

function doldurAnaIslemSecenekleri() {
  const select = document.getElementById("anaIslem");
  select.innerHTML = ""; // önce temizle

  const tx = db.transaction("Fiyatlar", "readonly");
  const store = tx.objectStore("Fiyatlar");

  store.getAll().onsuccess = function(e) {
    const islemler = e.target.result.filter(f => f.kod.startsWith("A"));

    islemler.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.kod;       // örnek: A1
      opt.textContent = f.isim; // örnek: İÇDIŞ
      select.appendChild(opt);
    });

    // Gerekirse varsayılan seçim sonrası toplamı güncelle
    guncelleToplamOdeme();
  };
}

function guncelleIsimlerleFiyatEtiketleri() {
  const tx = db.transaction("Fiyatlar", "readonly");
  const store = tx.objectStore("Fiyatlar");

  store.getAll().onsuccess = function(e) {
    const fiyatlar = e.target.result;

    // Ana işlem isimlerini güncelle (kodları A ile başlayanlar)
    const anaIslemOptions = document.getElementById("anaIslem").options;
    for (let i = 0; i < anaIslemOptions.length; i++) {
      const mevcut = anaIslemOptions[i];
      const kayit = fiyatlar.find(f => f.kod.startsWith("A") && f.isim === mevcut.text);
      if (kayit) mevcut.text = kayit.isim;
    }

    // Ekstra toggle butonlarını güncelle (kodları E ile başlayanlar)
    document.querySelectorAll('.toggle-button').forEach(btn => {
      const kod = btn.dataset.value; // artık "E1", "E2" gibi geliyor
      const kayit = fiyatlar.find(f => f.kod === kod);
      if (kayit) btn.innerText = kayit.isim;
    });
  };
}

document.addEventListener("DOMContentLoaded", () => {
  doldurYedekSecimi();
});

document.addEventListener("DOMContentLoaded", () => {
  const plakaFilter = document.getElementById("filterPlaka");
  if (plakaFilter) {
    plakaFilter.addEventListener("input", function () {
      this.value = this.value.toUpperCase();
    });
  }
});

document.addEventListener("DOMContentLoaded", () => {

  const plakaInput = document.getElementById("plaka");
  if (plakaInput) {
    plakaInput.addEventListener("input", function () {
      this.value = this.value.toUpperCase();
    });
  }

  gizleRaporFormu();
    gosterSadeceListe();
  const today = new Date().toISOString().slice(0, 10);
  document.getElementById("filterStartDate").value = today;
  document.getElementById("filterEndDate").value = today;
});


function gosterFiyatFormu() {
  const alan = document.getElementById("fiyatlarListesi");
  alan.innerHTML = "";

  const tx = db.transaction("Fiyatlar", "readonly");
  const store = tx.objectStore("Fiyatlar");
  store.getAll().onsuccess = function(e) {
    e.target.result.forEach(f => {
      let kodEtiketi = "";
      if (f.kod.startsWith("A")) {
        kodEtiketi = "Ana İşlem " + f.kod.replace("A", "");
      } else if (f.kod.startsWith("E")) {
        kodEtiketi = "Ekstra İşlem " + f.kod.replace("E", "");
      } else {
        kodEtiketi = f.kod;
      }

      const satir = document.createElement("div");
satir.style.display = "flex";
satir.style.alignItems = "center";   
satir.style.gap = "10px";
satir.style.marginBottom = "4px";

      satir.innerHTML = `
        <span style="width: 140px;">${kodEtiketi}</span>
        <input type="text" style="width: 140px" value="${f.isim}" id="isim_${f.kod}" />
        <input type="number" style="width: 80px" value="${f.tutar}" id="fiyat_${f.kod}" /> ₺
      `;
      alan.appendChild(satir);
    });
  };
}


function kaydetFiyatlar() {
  const tx = db.transaction("Fiyatlar", "readwrite");
  const store = tx.objectStore("Fiyatlar");

  document.querySelectorAll("#fiyatlarListesi input[id^='fiyat_']").forEach(input => {
    const kod = input.id.replace("fiyat_", "");
    const yeniTutar = parseFloat(input.value) || 0;
    const yeniIsim = document.getElementById("isim_" + kod)?.value || "";

    store.get(kod).onsuccess = function(e) {
      const kayit = e.target.result;
      if (kayit) {
        kayit.tutar = yeniTutar;
        kayit.isim = yeniIsim;
        store.put(kayit);
      }
    };
  });

  alert("Fiyatlar güncellendi.");
  fiyatlariYukleVeCachele();
}


// Ortak görünüm kontrol fonksiyonu
function gosterSadeceListe() {
  const filt1 = document.getElementById("filterOdenmis");
  const filt2 = document.getElementById("filterOdenmemis");
  if (filt1 && !filt1.classList.contains("active")) filt1.classList.add("active");
  if (filt2 && !filt2.classList.contains("active")) filt2.classList.add("active");
document.getElementById("personelFormu").style.display = "none";
  document.getElementById("kayitFormu").style.display = "none";
  document.getElementById("listeFormu").style.display = "block";

  // Ödeme filtre butonları default true olacak şekilde kontrol et
  const od1 = document.getElementById("filterOdenmis");
  const od2 = document.getElementById("filterOdenmemis");
  if (!od1.classList.contains("active")) od1.classList.add("active");
  if (!od2.classList.contains("active")) od2.classList.add("active");
}

function gosterSadeceForm() {
  document.getElementById("personelFormu").style.display = "none";
  document.getElementById("kayitFormu").style.display = "block";
  document.getElementById("listeFormu").style.display = "none";
}

// Liste butonuna basıldığında sadece liste göster

// Yeni Araç butonuna basıldığında form açılır, liste kapanır

// Formdaki "Vazgeç" butonuna basıldığında tekrar listeye dön
document.getElementById("btnVazgec").addEventListener("click", () => {
  document.getElementById("kayitFormu").style.display = "none";
  listeleKayitlar();
  gizleRaporFormu();
    gosterSadeceListe();
});

function gosterSadecePersonel() {
  document.getElementById("kayitFormu").style.display = "none";
  document.getElementById("listeFormu").style.display = "none";
  document.getElementById("personelFormu").style.display = "block";
}


function gosterSadeceCari() {
  document.getElementById("kayitFormu").style.display = "none";
  document.getElementById("listeFormu").style.display = "none";
  document.getElementById("personelFormu").style.display = "none";
  document.getElementById("cariFormu").style.display = "block";
}


const ekstraKisaltmalar = {
  "E1": "O",     // Ozon
  "E2": "C",     // Cila
  "E3": "B",     // Buhar
  "E4": "D1",    // Detay1
  "E5": "D2",    // Detay2
  "E6": "P"      // PastaCila
};




  gizleRaporFormu();

const request = indexedDB.open("GopCarWash", 1);

request.onupgradeneeded = function(event) {
  db = event.target.result;

  // Fiyatlar tablosu
  if (!db.objectStoreNames.contains("Fiyatlar")) {
    const fiyatlarStore = db.createObjectStore("Fiyatlar", { keyPath: "kod" });

    fiyatlarStore.transaction.oncomplete = function () {
      const store = db.transaction("Fiyatlar", "readwrite").objectStore("Fiyatlar");
      const ornekFiyatlar = [
        { kod: 'A1', isim: 'İçdış', tutar: 400 },
        { kod: 'A2', isim: 'Dış', tutar: 250 },
        { kod: 'A3', isim: 'B.İçdış', tutar: 500 },
        { kod: 'A4', isim: 'B.Dış', tutar: 300 },
        { kod: 'A5', isim: 'M.İçdış', tutar: 800 },
        { kod: 'A6', isim: 'M.Dış', tutar: 500 },
        { kod: 'A7', isim: 'Motor', tutar: 250 },
        { kod: 'E1', isim: 'Ozon', tutar: 100 },
        { kod: 'E2', isim: 'Cila', tutar: 100 },
        { kod: 'E3', isim: 'Buhar', tutar: 200 },
        { kod: 'E4', isim: 'Detay1', tutar: 2000 },
        { kod: 'E5', isim: 'Detay2', tutar: 4000 },
        { kod: 'E6', isim: 'PastaCila', tutar: 5000 }
      ];
      ornekFiyatlar.forEach(f => store.add(f));
    };
  }

  // Diğer tablolar...
  if (!db.objectStoreNames.contains("Personeller")) {
    const store = db.createObjectStore("Personeller", { keyPath: "id" });
    store.createIndex("ad", "ad", { unique: false });
    store.createIndex("yemekUcreti", "yemekUcreti", { unique: false });
  }

  if (!db.objectStoreNames.contains("Cariler")) {
    const store = db.createObjectStore("Cariler", { keyPath: "id" });
    store.createIndex("unvan", "unvan", { unique: false });
  }

  if (!db.objectStoreNames.contains("kayitlar")) {
    db.createObjectStore("kayitlar", { keyPath: "id" });
  }
};

request.onsuccess = function(event) {
  db = event.target.result;

  if (db.objectStoreNames.contains("Fiyatlar")) {
    fiyatlariYukleVeCachele(guncelleIsimlerleFiyatEtiketleri);
    doldurAnaIslemSecenekleri();
  } else {
    console.warn("Fiyatlar tablosu bulunamadı.");
  }

  doldurPersonelFormu();
  yuklePersonellerCombobox();
  doldurCariFormu();
  listeleKayitlar();
};


document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnKaydet").addEventListener("click", kaydetKayit);
  document.getElementById("btnSil").addEventListener("click", () => {
    const aktifId = document.getElementById("kayitFormu").dataset.kayitId;
    if (aktifId) silKayit(aktifId);
  });
  document.getElementById("btnVazgec").addEventListener("click", () => {
    document.getElementById("kayitFormu").style.display = "none";
  });
});

function sifirlaDatabase() {
  const girilen = prompt("🔐 Veritabanını sıfırlamak için admin şifresini girin:");
  if (girilen !== adminSifre) {
    alert("❌ Hatalı şifre. İşlem iptal edildi.");
    return;
  }

  if (confirm("Tüm kayıtlar silinecek. Emin misiniz?")) {
    indexedDB.deleteDatabase("GopCarWash").onsuccess = () => {
      alert("✅ Tüm veriler silindi.");

      // 🔽 Listeyi manuel olarak temizle
      const tbody = document.getElementById("listeGovde");
      if (tbody) tbody.innerHTML = "";

      // 🔽 Özet alanını da sıfırla
      const ozet = document.getElementById("listeOzeti");
      if (ozet) ozet.innerHTML = "";
      alert("✅ Tüm Kayıtlar silindi.");
     
     location.reload();
    };
  }
}

function guncelleToplamOdeme() {
  const anaIslemSecim = document.getElementById("anaIslem").value;

  // Artık ana işlem seçimi "A1", "A2" gibi kod olduğu için direkt kod ile bul
  const ana = fiyatlarCache.find(f => f.kod === anaIslemSecim);
  let toplam = ana ? ana.tutar : 0;

  // Aktif ekstraları topla (kod bazlı eşleştir)
  document.querySelectorAll(".toggle-button.active").forEach(b => {
    const kod = b.dataset.value;
    const ex = fiyatlarCache.find(f => f.kod === kod);
    if (ex) toplam += ex.tutar;
  });

  // Diğer ücretleri ekle
  toplam += parseFloat(document.getElementById("ucretFarki").value || 0);
  toplam += parseFloat(document.getElementById("hariciUcret").value || 0);

  document.getElementById("toplamOdeme").innerText = "Toplam Ödeme: " + toplam.toFixed(0) + " ₺";
}

function resetForm() {
  const f = document.getElementById("kayitFormu");
  f.dataset.kayitId = "";
  f.querySelectorAll("input, select").forEach(el => el.value = el.tagName === "SELECT" ? "Seçiniz" : "");
  document.getElementById("anaIslem").value = "A1"
  document.getElementById("cari").value = "Bireysel";
  document.getElementById("ucretFarki").value = 0;
  document.getElementById("hariciUcret").value = 0;
  document.querySelectorAll(".toggle-button").forEach(b => b.classList.remove("active"));
  guncelleToplamOdeme();
}

function getNextSiraNo(callback) {
  const today = new Date();
  const yy = today.getFullYear().toString().slice(-2);
  const aa = (today.getMonth() + 1).toString().padStart(2, '0');
  const gg = today.getDate().toString().padStart(2, '0');
  const tarihKod = yy + aa + gg;

  const tx = db.transaction("kayitlar", "readonly");
  const store = tx.objectStore("kayitlar");
  const req = store.getAll();
  req.onsuccess = () => {
    const bugunKayitlari = req.result.filter(k => k.sirano && k.sirano.startsWith(tarihKod));
    const maxNo = bugunKayitlari.reduce((m, k) => Math.max(m, parseInt(k.sirano.split("-")[1] || "0")), 0);
    const yeni = (maxNo + 1).toString().padStart(3, "0");
    callback(`${tarihKod}-${yeni}`);
  };
}

function kaydetKayit() {
  const kayitId = document.getElementById("kayitFormu").dataset.kayitId;
  const id = kayitId || crypto.randomUUID();

  const cariVal = document.getElementById("cari").value;
  const odemeVal = document.getElementById("odemeTipi").value;

  if (cariVal !== "Bireysel" && odemeVal !== "vadeli") {
    alert("Bireysel harici carilerde ödeme tipi 'vadeli' olmalıdır.");
    return;
  }

  if (cariVal === "Bireysel" && odemeVal === "vadeli") {
    alert("Bireysel müşteriler için ödeme tipi 'vadeli' olamaz.");
    return;
  }

  function devamEt(sn) {
    const toplamOdeme = parseFloat(document.getElementById("toplamOdeme").innerText.replace(/[^\d.]/g, "")) || 0;
    const nakit = parseFloat(document.getElementById("nakitOdeme").value || 0);
    const kart = parseFloat(document.getElementById("krediKartOdeme").value || 0);
    const vadeli = parseFloat(document.getElementById("vadeliOdeme").value || 0);
    const toplamOdemeGirilen = nakit + kart + vadeli;

    const hariciUcret = parseFloat(document.getElementById("hariciUcret").value || 0);
    if (hariciUcret < 0) {
      alert("Harici ücret negatif olamaz.");
      return;
    }

    if (nakit < 0 || kart < 0 || vadeli < 0) {
      alert("Ödeme tutarları negatif olamaz.");
      return;
    }

    // Ödeme tipi otomatik ayarı
    if (nakit === toplamOdeme && kart === 0 && vadeli === 0) {
      document.getElementById("odemeTipi").value = "nakit";
    } else if (kart === toplamOdeme && nakit === 0 && vadeli === 0) {
      document.getElementById("odemeTipi").value = "kredi kartı";
    } else if (vadeli === toplamOdeme && nakit === 0 && kart === 0) {
      document.getElementById("odemeTipi").value = "vadeli";
    } else if (nakit === 0 && kart === 0 && vadeli === 0) {
      document.getElementById("odemeTipi").value = "Seçiniz";
    }

    const odemeVal = document.getElementById("odemeTipi").value;

    if (hariciUcret > 0 && toplamOdemeGirilen < toplamOdeme) {
      alert("Harici ücret girildiği için eksik ödeme yapılamaz.");
      return;
    }

    if (cariVal === "Bireysel" && vadeli > 0) {
      alert("Bireysel müşteride vadeli ödeme girilemez.");
      return;
    }

    if (cariVal !== "Bireysel" && (nakit > 0 || kart > 0)) {
      alert("Cari müşteride sadece vadeli ödeme olabilir.");
      return;
    }

    if (toplamOdemeGirilen < toplamOdeme) {
      if (odemeVal !== "Seçiniz" && (cariVal !== "Bireysel" || odemeVal === "vadeli")) {
        alert("Cari veya vadeli ödemelerde eksik ödeme kabul edilemez.");
        return;
      }
      if (odemeVal !== "Seçiniz") {
        if (!confirm("Girilen ödeme toplamı, toplam ücretten düşük. Yine de kaydetmek istiyor musunuz?")) return;
      }
    }

    if (toplamOdemeGirilen > toplamOdeme) {
      const tipler = [nakit > 0, kart > 0, vadeli > 0].filter(Boolean).length;
      if (tipler === 1) {
        if (nakit > 0) document.getElementById("nakitOdeme").value = toplamOdeme;
        if (kart > 0) document.getElementById("krediKartOdeme").value = toplamOdeme;
        if (vadeli > 0) document.getElementById("vadeliOdeme").value = toplamOdeme;
      } else {
        alert("Toplam ödeme fazla ve birden fazla ödeme türü var. Lütfen düzeltin.");
        return;
      }
    }

    const veri = {
      id,
      sirano: sn,
      plaka: document.getElementById("plaka").value || "",
      aciklama: document.getElementById("aciklama").value || "",
      anaIslem: document.getElementById("anaIslem").value || "",
      cari: document.getElementById("cari").value || "",
      personel: document.getElementById("personel").value || "",
      odemeTipi: odemeVal || "Seçiniz",
      nakitOdeme: nakit,
      krediKartOdeme: kart,
      vadeliOdeme: vadeli,
      hariciUcret,
      ucretFarki: parseFloat(document.getElementById("ucretFarki").value || 0),
      toplamOdeme: document.getElementById("toplamOdeme").innerText || "Toplam Ödeme: 0 ₺",
      kayitZamani: new Date().toLocaleString("tr-TR"),
      cancelled: false,
      ekstra: []
    };

    document.querySelectorAll(".toggle-button.active").forEach(b => veri.ekstra.push(b.dataset.value));

    const tx = db.transaction("kayitlar", "readwrite");
    tx.objectStore("kayitlar").put(veri);
    tx.oncomplete = () => {
      document.getElementById("kayitFormu").style.display = "none";
      document.getElementById("kayitFormu").dataset.kayitId = "";
      listeleKayitlar();
      gizleRaporFormu();
      gosterSadeceListe();
    };
  }

  if (kayitId) {
    const tx = db.transaction("kayitlar", "readonly");
    tx.objectStore("kayitlar").get(kayitId).onsuccess = function (e) {
      const eskiKayit = e.target.result;
      if (eskiKayit && eskiKayit.kayitZamani) {
        const kayitTarihi = eskiKayit.kayitZamani.split(/[ ,]/)[0];
        const bugunStr = new Date().toLocaleDateString("tr-TR");
        if (kayitTarihi !== bugunStr) {
          alert("Yalnızca bugüne ait kayıtlar düzenlenebilir.");
          return;
        }
      }
      devamEt(eskiKayit.sirano);
    };
  } else {
    getNextSiraNo(devamEt);
  }
}

function silKayit(id) {
  const tx = db.transaction("kayitlar", "readonly");
  tx.objectStore("kayitlar").get(id).onsuccess = function (e) {
    const kayit = e.target.result;
    if (kayit && kayit.kayitZamani) {
      const kayitTarihi = kayit.kayitZamani.split(/[ ,]/)[0];
      const bugunStr = new Date().toLocaleDateString("tr-TR");
      if (kayitTarihi !== bugunStr) {
        alert("Yalnızca bugüne ait kayıtlar silinebilir.");
        return;
      }
    }

    if (confirm("Bu kaydı iptal etmek istediğinize emin misiniz?")) {
      kayit.cancelled = true;

      const txGuncelle = db.transaction("kayitlar", "readwrite");
      txGuncelle.objectStore("kayitlar").put(kayit);
      txGuncelle.oncomplete = () => {
        document.getElementById("kayitFormu").style.display = "none";
        gosterSadeceListe();   
        listeleKayitlar();
      };
    }
  };
}

function detayliOdemeTipi(d) {
  const nakit = d.nakitOdeme || 0;
  const kart = d.krediKartOdeme || 0;
  const vadeli = d.vadeliOdeme || 0;
  const toplam = parseFloat((d.toplamOdeme || "0").replace(/[^\d.]/g, "")) || 0;
  const toplamGirilen = nakit + kart + vadeli;

  if (toplamGirilen === 0) return "---";
  if (toplamGirilen < toplam) return "Eksik Ödeme";

  const tipler = [];
  if (nakit > 0) tipler.push("Nakit");
  if (kart > 0) tipler.push("Kart");
  if (vadeli > 0) tipler.push("Vadeli");

  return tipler.join("+");
}

function listeleKayitlar() {
  const bugunStr = new Date().toLocaleDateString("tr-TR");
  const tx = db.transaction("kayitlar", "readonly");
  const store = tx.objectStore("kayitlar");

  store.getAll().onsuccess = function (e) {
    const tbody = document.getElementById("listeGovde");
    tbody.innerHTML = "";

    const kayitlar = e.target.result;
    const bugunKayitlar = kayitlar.filter(k => {
      const tarih = k.kayitZamani?.split(" ")[0];
      return tarih === bugunStr;
    });

    bugunKayitlar.sort((a, b) => b.sirano.localeCompare(a.sirano)).forEach(d => {
      const tr = document.createElement("tr");
      const anaIslemIsim = fiyatlarCache.find(f => f.kod === d.anaIslem)?.isim || d.anaIslem;

      let sinif = "";
      const nakit = d.nakitOdeme || 0;
      const kart = d.krediKartOdeme || 0;
      const vadeli = d.vadeliOdeme || 0;
      const toplam = parseFloat((d.toplamOdeme || "0").replace(/[^\d.]/g, "")) || 0;
      const girilen = nakit + kart + vadeli;

      if (girilen === 0) sinif = "odenmemis-kayit";
      else if (girilen < toplam) sinif = "eksik-odeme-kayit";
      else sinif = "odenmis-kayit";
      if (d.cancelled) sinif = "iptal-kayit";

      tr.className = sinif;
      tr.innerHTML = `
        <td>${d.sirano}</td>
        <td>${d.plaka}</td>
        <td>${anaIslemIsim}</td>
        <td>${d.ekstra.map(e => ekstraKisaltmalar[e] || e).join(",")}</td>
        <td style="text-align:right;">${toplam}</td>
        <td>${d.cari}</td>
        <td>${d.personel}</td>
        <td>${detayliOdemeTipi(d)}</td>
        <td>${d.kayitZamani}</td>
      `;
      tr.onclick = () => formuDoldur(d);
      tbody.appendChild(tr);
    });

    const toplamUcret = bugunKayitlar.reduce((acc, d) => {
      const t = parseFloat((d.toplamOdeme || "0").replace(/[^\d.]/g, "")) || 0;
      return acc + t;
    }, 0);
    const aracSayisi = bugunKayitlar.length;

    const ozetDiv = document.getElementById("listeOzeti");
    if (ozetDiv) {
      ozetDiv.innerHTML = `
        <div style="padding: 6px; font-weight: bold;">
          Araç Sayısı: ${aracSayisi} <br/>
          Toplam Ücret: ${toplamUcret.toLocaleString("tr-TR")} ₺
        </div>
      `;
    }
  };
}

function formuDoldur(d) {
  const f = document.getElementById("kayitFormu");
  f.dataset.kayitId = d.id;
  document.getElementById("plaka").value = d.plaka;
  document.getElementById("aciklama").value = d.aciklama;
  document.getElementById("anaIslem").value = d.anaIslem;
  document.getElementById("cari").value = d.cari;
  document.getElementById("personel").value = d.personel;
  document.getElementById("odemeTipi").value = d.odemeTipi;
  document.getElementById("ucretFarki").value = d.ucretFarki;
  document.getElementById("hariciUcret").value = d.hariciUcret;
  document.getElementById("nakitOdeme").value = d.nakitOdeme || 0;
  document.getElementById("krediKartOdeme").value = d.krediKartOdeme || 0;
  document.getElementById("vadeliOdeme").value = d.vadeliOdeme || 0;

  document.querySelectorAll(".toggle-button").forEach(b => {
    b.classList.toggle("active", d.ekstra.includes(b.dataset.value));
  });
  guncelleToplamOdeme();
  f.style.display = "block";
  document.getElementById("listeFormu").style.display = "none";
}

function filtreleKayitlar() {
  const start = document.getElementById("filterStartDate").value;
  const end = document.getElementById("filterEndDate").value;
  const plaka = document.getElementById("filterPlaka").value.toLowerCase();
  const personel = document.getElementById("filterPersonel").value.toLowerCase();
  const cariTipi = document.getElementById("filterCariTipi").value.toLowerCase();

  const tx = db.transaction("kayitlar", "readonly");
  tx.objectStore("kayitlar").getAll().onsuccess = function(e) {
    const tbody = document.getElementById("listeGovde");
    tbody.innerHTML = "";
    const filtered = e.target.result.filter(d => {
      const tarihStr = d.kayitZamani.split(" ")[0];
      const tarih = new Date(tarihStr.split(".").reverse().join("-"));
      const startDate = new Date(start);
      const endDate = new Date(end);
      if (start && tarih < startDate) return false;
      if (end && tarih > endDate) return false;
      if (plaka && !d.plaka.toLowerCase().includes(plaka)) return false;
      if (personel && !d.personel.toLowerCase().includes(personel)) return false;
      if (cariTipi && !(d.cari || "").toLowerCase().includes(cariTipi)) return false;

      const nakit = d.nakitOdeme || 0;
      const kart = d.krediKartOdeme || 0;
      const vadeli = d.vadeliOdeme || 0;
      const toplam = parseFloat((d.toplamOdeme || "0").replace(/[^\d.]/g, "")) || 0;
      const girilen = nakit + kart + vadeli;

      const showOdenmis = document.getElementById("filterOdenmis").classList.contains("active");
      const showOdenmemis = document.getElementById("filterOdenmemis").classList.contains("active");
      const isOdenmis = girilen >= toplam;

      if ((isOdenmis && !showOdenmis) || (!isOdenmis && !showOdenmemis)) return false;

      return true;
    });

    filtered.sort((a, b) => b.sirano.localeCompare(a.sirano)).forEach(d => {
      const tr = document.createElement("tr");
      const anaIslemIsim = fiyatlarCache.find(f => f.kod === d.anaIslem)?.isim || d.anaIslem;

      const nakit = d.nakitOdeme || 0;
      const kart = d.krediKartOdeme || 0;
      const vadeli = d.vadeliOdeme || 0;
      const toplam = parseFloat((d.toplamOdeme || "0").replace(/[^\d.]/g, "")) || 0;
      const girilen = nakit + kart + vadeli;

      let sinif = "";
      if (girilen === 0) sinif = "odenmemis-kayit";
      else if (girilen < toplam) sinif = "eksik-odeme-kayit";
      else sinif = "odenmis-kayit";
      if (d.cancelled) sinif = "iptal-kayit";
      tr.className = sinif;

      tr.innerHTML = `
        <td style="text-align:left;">${d.sirano}</td>
        <td style="text-align:left;">${d.plaka}</td>
        <td style="text-align:left;">${anaIslemIsim}</td>
        <td style="text-align:left;">${d.ekstra.map(e => ekstraKisaltmalar[e] || e).join(",")}</td>
        <td style="text-align:right;">${parseFloat(d.toplamOdeme.replace(/[^\d.]/g, "")) || 0}</td>
        <td style="text-align:left;">${d.cari}</td>
        <td style="text-align:left;">${d.personel}</td>
        <td style="text-align:left;">${detayliOdemeTipi(d)}</td>
        <td style="text-align:left;">${d.kayitZamani}</td>
      `;
      tr.onclick = () => formuDoldur(d);
      tbody.appendChild(tr);
    });

    const toplamUcret = filtered.reduce((acc, d) => {
      const t = parseFloat((d.toplamOdeme || "0").replace(/[^\d.]/g, "")) || 0;
      return acc + t;
    }, 0);
    const aracSayisi = filtered.length;
    const ozetDiv = document.getElementById("listeOzeti");
    if (ozetDiv) {
      ozetDiv.innerHTML = `
        <div style="padding: 6px; font-weight: bold;">
          Araç Sayısı: ${aracSayisi} <br/>
          Toplam Ücret: ${toplamUcret.toLocaleString("tr-TR")} ₺
        </div>
      `;
    }
  };
}


function temizleFiltreVeListele() {
  const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD formatı

  document.getElementById("filterStartDate").value = today;
  document.getElementById("filterEndDate").value = today;
  document.getElementById("filterPlaka").value = "";
  document.getElementById("filterPersonel").value = "";
  document.getElementById("filterCariTipi").value = "";

  listeleKayitlar();
}

document.addEventListener("DOMContentLoaded", () => {
  const kutuAlan = document.getElementById("personelKutulari");
  if (kutuAlan) {
    for (let i = 1; i <= 30; i++) {
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Personel " + i;
      input.id = "p" + i;
      kutuAlan.appendChild(input);
    }
  }

  const cariAlan = document.getElementById("cariKutulari");
  if (cariAlan) {
    for (let i = 1; i <= 30; i++) {
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Cari " + i;
      input.id = "c" + i;
      cariAlan.appendChild(input);
    }
  }
});



function aktarCariComboboxa() {
  const cariCombo = document.getElementById("cari");
  while (cariCombo.options.length > 1) {
    cariCombo.remove(1);
  }

  const tx = db.transaction("Cariler", "readwrite");
  const store = tx.objectStore("Cariler");

  for (let i = 1; i <= 30; i++) {
    const val = document.getElementById("c" + i).value.trim();
    if (val) {
      store.put({ id: "c" + i, unvan: val });
      const opt = document.createElement("option");
      opt.value = val;
      opt.text = val;
      cariCombo.appendChild(opt);
    }
  }

  alert("Cari listesi ve veritabanı güncellendi.");
}

function gizleRaporFormu() {
  document.getElementById("raporFormu").style.display = "none";
}

function gizleCariFormu() {
    document.getElementById("cariFormu").style.display = "none";
}

// Liste butonuna tıklanınca


function gosterSadeceRapor() {
  document.getElementById("kayitFormu").style.display = "none";
  document.getElementById("listeFormu").style.display = "none";
  document.getElementById("personelFormu").style.display = "none";
  document.getElementById("cariFormu").style.display = "none";
  document.getElementById("raporFormu").style.display = "block";
}



// Personel butonuna tıklanınca

// Yeni Araç butonuna tıklanınca



function doldurPersonelFormu() {
  const kutuAlan = document.getElementById("personelKutulari");
  kutuAlan.innerHTML = "";
  for (let i = 1; i <= 30; i++) {
    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.alignItems = "center";
    wrapper.style.gap = "6px";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Personel " + i;
    input.id = "p" + i;

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.id = "yemek" + i;
    const label = document.createElement("label");
    label.textContent = "YemekUcreti";
    label.setAttribute("for", checkbox.id);

    wrapper.appendChild(input);
    wrapper.appendChild(checkbox);
    wrapper.appendChild(label);
    kutuAlan.appendChild(wrapper);
  }

  const tx = db.transaction("Personeller", "readonly");
  const store = tx.objectStore("Personeller");
  store.getAll().onsuccess = function(e) {
    const data = e.target.result;
    data.forEach((p, index) => {
      const idx = index + 1;
      if (idx <= 30) {
        document.getElementById("p" + idx).value = p.ad || "";
        document.getElementById("yemek" + idx).checked = !!p.yemekUcreti;
      }
    });
  };
}

function aktarPersonelComboboxa() {
  const personelCombo = document.getElementById("personel");
  while (personelCombo.options.length > 1) {
    personelCombo.remove(1);
  }

  const tx = db.transaction("Personeller", "readwrite");
  const store = tx.objectStore("Personeller");

  for (let i = 1; i <= 30; i++) {
    const val = document.getElementById("p" + i).value.trim();
    const yemek = document.getElementById("yemek" + i).checked;
    if (val) {
      store.put({ id: "p" + i, ad: val, yemekUcreti: yemek });
      const opt = document.createElement("option");
      opt.value = val;
      opt.text = val;
      personelCombo.appendChild(opt);
    }
  }

  alert("Personel listesi ve veritabanı güncellendi.");
}

function yuklePersonellerCombobox() {
  const personelCombo = document.getElementById("personel");
  if (!personelCombo) return;

  while (personelCombo.options.length > 1) {
    personelCombo.remove(1);
  }

  const tx = db.transaction("Personeller", "readonly");
  const store = tx.objectStore("Personeller");
  store.getAll().onsuccess = function(e) {
    const data = e.target.result;
    data.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.ad;
      opt.text = p.ad;
      personelCombo.appendChild(opt);
    });
  };
}

function doldurCariFormu() {
  const cariAlan = document.getElementById("cariKutulari");
  if (!cariAlan) return;

  cariAlan.innerHTML = "";
  for (let i = 1; i <= 30; i++) {
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Cari " + i;
    input.id = "c" + i;
    cariAlan.appendChild(input);
  }

  const tx = db.transaction("Cariler", "readonly");
  const store = tx.objectStore("Cariler");

  store.getAll().onsuccess = function (e) {
    const data = e.target.result;

    // Inputlara doldur
    data.forEach((cari, index) => {
      const idx = index + 1;
      if (idx <= 30) {
        document.getElementById("c" + idx).value = cari.unvan || "";
      }
    });

    // Combobox'u da doldur
    const cariCombo = document.getElementById("cari");
    if (cariCombo) {
      while (cariCombo.options.length > 1) {
        cariCombo.remove(1);
      }
      data.forEach(cari => {
        const opt = document.createElement("option");
        opt.value = cari.unvan;
        opt.text = cari.unvan;
        cariCombo.appendChild(opt);
      });
    }
  };
}


function yuvarla5Uzeri(tutar) {
  return Math.ceil(tutar / 5) * 5;
}


function olusturHakedişRaporu() {
  const seciliTarih = document.getElementById("raporTarihi").value;
  const tx = db.transaction(["kayitlar", "Personeller"], "readonly");
  const kayitlarStore = tx.objectStore("kayitlar");
  const personelStore = tx.objectStore("Personeller");

  Promise.all([
    new Promise(resolve => kayitlarStore.getAll().onsuccess = e => resolve(e.target.result)),
    new Promise(resolve => personelStore.getAll().onsuccess = e => resolve(e.target.result))
  ]).then(([kayitlar, personeller]) => {
    const yemekUcretiAlanlar = new Set(
      personeller.filter(p => p.yemekUcreti).map(p => p.ad)
    );

    const gunlukKayitlar = kayitlar.filter(k => {
      if (k.cancelled) return false;
      if (!k.kayitZamani) return false;
      const kayitTarih = k.kayitZamani.split(" ")[0].split(".").reverse().join("-");
      return kayitTarih === seciliTarih;
    });

const ozet = {};

gunlukKayitlar.forEach(k => {
  const p = k.personel || "Personel Seçilmemiş";

  const anaKayit = fiyatlarCache.find(f => f.kod === k.anaIslem);
  const anaUcret = anaKayit ? anaKayit.tutar : 0;

  // Ekstra işlem toplamı: kodlarla eşleşen E kodlu satırlar
  const ekstraToplam = (k.ekstra || []).reduce((sum, kod) => {
    const f = fiyatlarCache.find(f => f.kod === kod);
    return sum + (f ? f.tutar : 0);
  }, 0);

  const ucretFarki = k.ucretFarki || 0;
  const toplam = anaUcret + ekstraToplam + ucretFarki;

  if (!ozet[p]) {
    ozet[p] = { adet: 0, toplam: 0, yemek: yemekUcretiAlanlar.has(p) };
  }
  ozet[p].adet += 1;
  ozet[p].toplam += toplam;
});

    let html = `
      <table border="1" cellpadding="5" cellspacing="0" style="width:100%; max-width:680px;">
        <tr>
          <th>Personel</th><th style="text-align:right;">Adet</th><th style="text-align:right;">Toplam</th><th>Yemek</th><th style="text-align:right;">%25 Hakediş</th><th style="text-align:right;">Yemek Ücreti</th><th style="text-align:right;">Genel Toplam</th>
        </tr>
    `;

    let genelAdet = 0, genelToplam = 0, genelHakediş = 0, genelYemek = 0;

    Object.entries(ozet).forEach(([ad, v]) => {
      const hak = yuvarla5Uzeri(v.toplam * 0.25);
      const yemek = v.yemek ? 130 : 0;
      const toplam = hak + yemek;
      genelAdet += v.adet;
      genelToplam += v.toplam;
      genelHakediş += hak;
      genelYemek += yemek;

      html += `
        <tr>
          <td>${ad}</td><td style="text-align:right;">${v.adet}</td><td style="text-align:right;">${v.toplam}</td><td style="text-align:right;">${v.yemek ? "✔️" : "-"}</td>
          <td style="text-align:right;">${hak.toFixed(0)}</td><td style="text-align:right;">${yemek}</td><td style="text-align:right;">${toplam.toFixed(0)}</td>
        </tr>
      `;
    });

    html += `
      <tr style="font-weight:bold; background:#dfd;">
        <td>TOPLAM</td><td style="text-align:right;">${genelAdet}</td><td style="text-align:right;">${genelToplam}</td><td style="text-align:right;">-</td>
        <td>${genelHakediş.toFixed(0)}</td><td style="text-align:right;">${genelYemek}</td><td style="text-align:right;">${(genelHakediş + genelYemek).toFixed(0)}</td>
      </tr>
    `;

    html += `</table>`;
    document.getElementById("raporTabloAlani").innerHTML = html;
    olusturGunsonuOzet(gunlukKayitlar, genelHakediş + genelYemek, kayitlar, seciliTarih);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("raporTarihi");
  if (input) {
    input.addEventListener("change", olusturHakedişRaporu);
  }
});



function olusturGunsonuOzet(gunlukKayitlar, personelHakToplami, tumKayitlar, seciliTarih) {
  
  let cariAdet = gunlukKayitlar.filter(k => (k.vadeliOdeme || 0) > 0).length;

  let toplamNakit = 0;
  let toplamKart = 0;
  let toplamVadeli = 0;
  let toplamHarici = 0;
  let odememisToplam = 0;
  let toplamCiro = 0;

  gunlukKayitlar.forEach(k => {
    const nakit = k.nakitOdeme || 0;
    const kart = k.krediKartOdeme || 0;
    const vadeli = k.vadeliOdeme || 0;
    const harici = k.hariciUcret || 0;

    const toplam = parseFloat((k.toplamOdeme || "0").replace(/[^\d.]/g, "")) || 0;
    const toplamGirilen = nakit + kart + vadeli;

    // Nakitten harici düşülür
    toplamNakit += nakit;
    toplamKart += kart;
    toplamVadeli += vadeli;
    toplamHarici += harici;

    // Eksik ödeme varsa ödenmemiş olarak eklenir
    if (toplamGirilen < toplam) {
      odememisToplam += (toplam - toplamGirilen);
    }

    // Ciro = toplam - harici
    toplamCiro += (toplam - harici);
  });

  toplamNakit -= (toplamHarici + personelHakToplami); // Harici nakitten düşülür

  // Silinmiş kayıtları bul
  const silinmisAdet = tumKayitlar.filter(k => {
    if (!k.cancelled) return false;
    if (!k.kayitZamani) return false;
    const tarih = k.kayitZamani.split(" ")[0].split(".").reverse().join("-");
    return tarih === seciliTarih;
  }).length;

  let html = `
    <h3>Günsonu Özeti</h3>
    <table border="1" cellpadding="5" cellspacing="0">
      
      <tr><td>1) Personel Hakediş Genel Toplamı</td><td style="text-align:right;">${personelHakToplami.toFixed(0)} ₺</td></tr>
      <tr><td>2) Nakit</td><td style="text-align:right;">${toplamNakit.toFixed(0)} ₺</td></tr>
      <tr><td>3) Kredi Kartı</td><td style="text-align:right;">${toplamKart.toFixed(0)} ₺</td></tr>
      <tr><td>4) Cari Ödemeler <span style="font-size:smaller;">(Adet: ${cariAdet})</span></td><td style="text-align:right;">${toplamVadeli.toFixed(0)} ₺</td></tr>
      <tr><td>5) Ödenmemişler</td><td style="text-align:right;">${odememisToplam.toFixed(0)} ₺</td></tr>
      <tr><td>6) Toplam Ciro</td><td style="text-align:right;">${toplamCiro.toFixed(0)} ₺</td></tr>
      <tr><td colspan="2" style="font-style: italic;"><span style="color:red;">Not: Alınan toplam harici ücret = ${toplamHarici.toFixed(0)} ₺</span></td></tr>
      <tr><td colspan="2" style="font-style: italic; color:red;">Not: Bugün ${silinmisAdet} kayıt silinmiş.</td></tr>
    </table>
  `;

  const container = document.createElement("div");
  container.innerHTML = html;
  
  // Cari bazlı vadeli ödemeler
  const cariOzet = {};
  gunlukKayitlar.forEach(k => {
    if ((k.vadeliOdeme || 0) > 0 && !k.cancelled) {
      const cari = k.cari || "Belirtilmemiş";
      if (!cariOzet[cari]) cariOzet[cari] = { adet: 0, toplam: 0 };
      cariOzet[cari].adet++;
      cariOzet[cari].toplam += k.vadeliOdeme;
    }
  });

  let cariTable = "";
  if (Object.keys(cariOzet).length > 0) {
    cariTable += "<h3>Cari Bazlı Vadeli Ödemeler</h3><table border='1' cellpadding='5' cellspacing='0' style='width:100%; max-width:680px;'>";
    cariTable += "<tr><th>Cari</th><th>Adet</th><th style='text-align:right;'>Vadeli Tutar</th></tr>";
    for (const [cari, data] of Object.entries(cariOzet)) {
      cariTable += `<tr><td>${cari}</td><td style="text-align:right;">${data.adet}</td><td style="text-align:right;">${data.toplam.toFixed(0)} ₺</td></tr>`;
    }
    cariTable += "</table>";
  }

  document.getElementById("raporTabloAlani").appendChild(container);
  if (cariTable) document.getElementById("raporTabloAlani").innerHTML += cariTable;
}

document.addEventListener("DOMContentLoaded", () => {
  const cariSelect = document.getElementById("cari");
  const odemeTipiSelect = document.getElementById("odemeTipi");

  function cariDegisimKontrol() {
    if (cariSelect.value !== "Bireysel") {
      odemeTipiSelect.value = "vadeli";
      const toplam = parseFloat(document.getElementById("toplamOdeme").innerText.replace(/[^\d.]/g, "")) || 0;
      document.getElementById("nakitOdeme").value = 0;
      document.getElementById("krediKartOdeme").value = 0;
      document.getElementById("vadeliOdeme").value = toplam;
    }
  }

  cariSelect.addEventListener("change", cariDegisimKontrol);
  cariSelect.addEventListener("click", cariDegisimKontrol);
});

document.addEventListener("DOMContentLoaded", () => {

  document.getElementById("btnAyarlar")?.addEventListener("click", () => {
    gizleTumFormlar();
    document.getElementById("ayarlarFormu").style.display = "block";
    fiyatlariYukleVeCachele(gosterFiyatFormu); // ✅ doğru
  });

});


function kaydetAyarlar() {
  const ayar1 = document.getElementById("ayar1").value;
  const ayar2 = document.getElementById("ayar2").checked;
  alert("Ayarlar kaydedildi:\nAyar1: " + ayar1 + "\nAyar2: " + (ayar2 ? "Aktif" : "Pasif"));
}

function gizleTumFormlar() {
  ['kayitFormu', 'listeFormu', 'personelFormu', 'cariFormu', 'raporFormu', 'ayarlarFormu'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });
}

document.addEventListener("DOMContentLoaded", () => {

  document.getElementById("btnPersonel")?.addEventListener("click", () => {
    gizleTumFormlar();
    document.getElementById("personelFormu").style.display = "block";
  });

  document.getElementById("btnCari")?.addEventListener("click", () => {
    gizleTumFormlar();
    document.getElementById("cariFormu").style.display = "block";
  });

  document.getElementById("btnYeniArac")?.addEventListener("click", () => {
    gizleTumFormlar();
    resetForm();
    document.getElementById("kayitFormu").style.display = "block";
    guncelleToplamOdeme();
  });

  document.getElementById("btnListe")?.addEventListener("click", () => {
    gosterSadeceListe();
    gizleTumFormlar();
    document.getElementById("listeFormu").style.display = "block";
    listeleKayitlar();
  });

  document.getElementById("btnRapor")?.addEventListener("click", () => {
    gizleTumFormlar();
    document.getElementById("raporFormu").style.display = "block";
    olusturHakedişRaporu();
  });

});

document.addEventListener("DOMContentLoaded", () => {

  const btn = document.querySelector("#ayarlarFormu #btnPersonel");
  if (btn) {
    btn.addEventListener("click", () => {
      gizleTumFormlar();
      document.getElementById("personelFormu").style.display = "block";
    });
  }

});

document.addEventListener("DOMContentLoaded", () => {
  const btnCari = document.querySelector("#ayarlarFormu #btnCari");
  if (btnCari && !btnCari.dataset.listenerAdded) {
    btnCari.addEventListener("click", () => {
      gizleTumFormlar();
      document.getElementById("cariFormu").style.display = "block";
    });
    btnCari.dataset.listenerAdded = "true";
  }

const btnSifirla = document.getElementById("btnSifirlaDB");
if (btnSifirla && !btnSifirla.dataset.listenerAdded) {
  btnSifirla.addEventListener("click", () => {
    sifirlaDatabase();
  });
  btnSifirla.dataset.listenerAdded = "true";
}
});

document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("raporTarihi");
  if (input) {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    input.value = `${yyyy}-${mm}-${dd}`;
  }
});


</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("sifre").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      kontrolEtGiris();
    }
  });
});
</script>
<script>
function odemeTipiDegisti() {
  const tip = document.getElementById("odemeTipi").value;
  const toplam = parseFloat(document.getElementById("toplamOdeme").innerText.replace(/[^\d.]/g, "")) || 0;

  const nakit = document.getElementById("nakitOdeme");
  const kart = document.getElementById("krediKartOdeme");
  const vadeli = document.getElementById("vadeliOdeme");

  nakit.value = kart.value = vadeli.value = 0;

  if (tip === "nakit") nakit.value = toplam;
  if (tip === "kredi kartı") kart.value = toplam;
  if (tip === "vadeli") vadeli.value = toplam;

  if (typeof guncelleToplamOdeme === "function") {
    guncelleToplamOdeme();
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const odemeTipi = document.getElementById("odemeTipi");
  if (odemeTipi) {
    odemeTipi.removeEventListener("change", odemeTipiDegisti);
    odemeTipi.removeEventListener("click", odemeTipiDegisti);

    odemeTipi.addEventListener("change", odemeTipiDegisti);
    odemeTipi.addEventListener("click", odemeTipiDegisti);
  }
});
</script>

<script>
  // Firebase yapılandırması
  const firebaseConfig = {
    apiKey: "AIzaSyBu3zfCExdawrUln1J8CmT_nxarTJR0Zoc",
    authDomain: "gopcarwash.firebaseapp.com",
    databaseURL: "https://gopcarwash-default-rtdb.firebaseio.com",
    projectId: "gopcarwash",
    storageBucket: "gopcarwash.firebasestorage.app",
    messagingSenderId: "1044228778723",
    appId: "1:1044228778723:web:db96bc6ae328a7bf1973d6",
    measurementId: "G-DX6D6V6XV5"
  };

  // Firebase'i başlat
  firebase.initializeApp(firebaseConfig);
  const dbFirebase = firebase.database();
</script>
<script>

async function okuTumVeriler() {
  const storeAdlari = ["Fiyatlar", "Personeller", "Cariler", "kayitlar"];
  const sonuc = {};

  for (const ad of storeAdlari) {
    const tx = db.transaction(ad, "readonly");
    const store = tx.objectStore(ad);
    const veriler = await new Promise(resolve => {
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
    });
    sonuc[ad] = veriler;
  }

  return sonuc;
}

async function yedekleFirebase() {
  if (!CihazIsmi) {
    alert("Cihaz ismi tanımlı değil!");
    return;
  }

  const yedekYolu = `yedekler/${CihazIsmi}`;
  const veriler = await okuTumVeriler();

  // ✅ Yedekleme zamanını ekle
  veriler._metadata = {
    yedeklemeZamani: new Date().toISOString()
  };

  try {
    await dbFirebase.ref(yedekYolu).remove();
    await dbFirebase.ref(yedekYolu).set(veriler);
    alert("✅ Yedekleme başarıyla tamamlandı.");
    doldurYedekSecimi(); // 🔁 Yedek listesini güncelle

  } catch (err) {
    console.error("Yedekleme hatası:", err);
    alert("❌ Yedekleme sırasında hata oluştu.");
  }
}

document.getElementById("btnBulutaKaydet").addEventListener("click", yedekleFirebase);

document.getElementById("btnBuluttanYukle").addEventListener("click", async () => {
  const girilen = prompt("🔐 Yedek yüklemek için admin şifresini girin:");
  if (girilen !== adminSifre) {
    alert("❌ Hatalı şifre. İşlem iptal edildi.");
    return;
  }

  if (!navigator.onLine) {
    alert("❌ İnternet bağlantısı yok. Lütfen bağlantınızı kontrol edin.");
    return;
  }

  const secim = document.getElementById("yedekSecim").value;
  const btn = document.getElementById("btnBuluttanYukle");

  if (!secim) {
    alert("Lütfen bir yedek seçin.");
    return;
  }

  btn.disabled = true;
  const eskiYazi = btn.textContent;
  btn.textContent = "⏳ Yükleniyor...";

  try {
    const snapshot = await dbFirebase.ref(`yedekler/${secim}`).get();
    if (!snapshot.exists()) {
      alert("Seçilen yedek bulunamadı.");
      return;
    }

    const veriler = snapshot.val();
    await geriYazIndexedDB(veriler);

    alert(`✅ ${secim} yedeği başarıyla yüklendi.`);

    location.reload();
  } catch (err) {
    console.error("Buluttan yükleme hatası:", err);
    alert("❌ Yedek yüklenirken hata oluştu.");
  } finally {
    btn.disabled = false;
    btn.textContent = eskiYazi;
  }
});


async function geriYazIndexedDB(veriler) {
  const tumTablolar = ["kayitlar", "Personeller", "Cariler", "Fiyatlar"];

  for (const ad of tumTablolar) {
    if (!db.objectStoreNames.contains(ad)) continue;

    const tx = db.transaction(ad, "readwrite");
    const store = tx.objectStore(ad);

    // 1. Mevcut verileri temizle
    await new Promise(resolve => {
      const clearReq = store.clear();
      clearReq.onsuccess = () => resolve();
      clearReq.onerror = () => resolve(); // hata olsa bile devam et
    });

    // 2. Firebase yedeğinde varsa, kayıtları ekle
    if (Array.isArray(veriler[ad])) {
      for (const kayit of veriler[ad]) {
        if (ad === "kayitlar" && !Array.isArray(kayit.ekstra)) {
          kayit.ekstra = [];
        }
        store.put(kayit);
      }
    }

    await new Promise(resolve => tx.oncomplete = resolve);
  }

  alert("✅ Buluttan veri başarıyla yüklendi.");
}



async function listeleYedekler() {
  const snapshot = await dbFirebase.ref("yedekler").get();
  if (!snapshot.exists()) {
    alert("Hiç yedek bulunamadı.");
    return [];
  }

  return Object.keys(snapshot.val()); // cihaz isimleri
}


async function doldurYedekSecimi() {
  if (!navigator.onLine) {
    alert("❌ İnternet bağlantısı yok. Lütfen bağlantınızı kontrol edin.");
    return;
  }

  const snapshot = await dbFirebase.ref("yedekler").get();
  const select = document.getElementById("yedekSecim");
  select.innerHTML = '<option value="">-- Yedek Seçin --</option>';

  if (snapshot.exists()) {
    const yedekler = snapshot.val();
    const bugun = new Date().toISOString().slice(0, 10);

    Object.entries(yedekler).forEach(([cihaz, veri]) => {
      let zamanStr = "";

      if (veri._metadata?.yedeklemeZamani) {
        const t = new Date(veri._metadata.yedeklemeZamani);
        const tarih = t.toLocaleDateString("tr-TR");
        const saat = t.toLocaleTimeString("tr-TR", { hour: '2-digit', minute: '2-digit' });
        zamanStr = ` (${tarih} ${saat})`;

        // 🔔 İsteğe bağlı: eskiyse uyarı ver
        const yedekTarihi = veri._metadata.yedeklemeZamani.slice(0, 10);
        if (cihaz === CihazIsmi && yedekTarihi !== bugun) {
          alert(`ℹ️ Uyarı: Bu cihaz (${cihaz}) için en son yedek ${tarih} tarihinde alınmış. Lütfen yedeği güncelleyin.`);
        }
      }

      const opt = document.createElement("option");
      opt.value = cihaz;
      opt.textContent = `${cihaz}${zamanStr}`;
      select.appendChild(opt);
    });
  } else {
    alert("Hiç yedek bulunamadı.");
  }
}

</script>

</body>
</html>
